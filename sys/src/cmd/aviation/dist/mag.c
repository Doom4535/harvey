#include <u.h>
#include <libc.h>
#include "obj.h"

int	mag[21][14] =
{
	0,0,0,0,0,0,0,0,0,0,1964,1982,2035,0,
	0,0,0,0,0,0,0,0,0,1527,1785,1915,2106,2115,
	0,0,0,0,0,0,0,0,1235,1449,1544,1757,1946,2115,
	0,0,0,0,0,0,701,793,956,1143,1311,1434,0,0,
	0,0,0,0,0,421,561,640,780,887,1006,1134,0,0,
	27,77,137,138,125,244,325,415,513,528,731,684,0,0,
	27,29,5,20,17,27,125,125,241,317,325,357,337,0,
	0,0,0,-91,-134,-80,-94,-103,8,17,40,137,235,-53,
	0,0,0,-354,-332,-297,-350,-357,-231,-213,-157,-63,-108,-245,
	0,0,0,-522,-519,-479,-491,-526,-453,-462,-417,-382,-340,-417,
	0,-756,-744,-651,-653,-631,-664,-653,-650,-652,-614,-643,-632,-628,
	0,-764,-755,-774,-825,-768,-808,-826,-854,-838,-838,-831,-841,-853,
	0,-792,-830,-882,-925,-937,-942,-961,-1037,-1035,-1051,-1050,-1115,-1149,
	0,0,0,-1007,-1011,-1077,-1088,-1157,-1172,-1198,-1261,-1255,-1337,-1438,
	0,0,0,-1015,-1135,-1149,-1207,-1327,-1315,-1343,-1427,-1469,-1589,-1645,
	0,0,0,0,-1235,-1280,-1313,-1360,-1429,-1466,-1582,-1645,-1734,-1763,
	0,0,0,0,-1316,-1323,-1405,-1450,-1499,-1557,-1647,-1779,-1887,-1914,
	0,0,0,0,-1380,-1379,-1451,-1524,-1623,-1708,-1764,-1847,-1987,-2045,
	0,0,0,0,-1411,-1440,-1502,-1562,-1655,-1778,-1840,-1890,-1991,-2099,
	0,0,0,0,0,-1484,-1551,-1630,-1730,-1825,-1887,-1954,-2054,-2159,
	0,0,0,0,0,0,0,-1675,-1739,-1846,-1918,-1994,-2097,-2209,
};

double
magvar(Obj *o)
{
	double lat, lng, flat, flng;
	double v, v0, v1, v2, v3;
	double v01, v23;
	int ilat, ilng;

	lat = (o->lat/RADIAN - 23.)/2.;
	lng = (o->lng/RADIAN - 65.)/3.;
	ilat = floor(lat);
	if(ilat < 0 || ilat >= 13)
		return 0;
	ilng = floor(lng);
	if(ilng < 0 || ilng >= 20)
		return(0.);
	v0 = mag[ilng][ilat];
	v1 = mag[ilng+1][ilat];
	v2 = mag[ilng][ilat+1];
	v3 = mag[ilng+1][ilat+1];

	if(v0 == 0 || v1 == 0 || v2 == 0 || v3 == 0)
		return 0;
	flng = lng - ilng;
	v01 = v0 + flng*(v1-v0);
	v23 = v2 + flng*(v3-v2);
	flat = lat - ilat;
	v = v01 + flat*(v23-v01);
	return v/100.;
}
