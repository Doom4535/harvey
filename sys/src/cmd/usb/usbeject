#!/bin/rc
# usbeject -- unmount usb disks given as arguments
# unmount all of them if no arguments given
rfork e
disk = ()
mtpt = /n/usb

test -e /dev/fs/ctl || bind -b '#k' /dev

test -e /dev/usb || bind -a '#u' /dev || {
	echo no '#u/usb' >[1=2]
	exit nousb
}
test -e /dev/usbdctl || mount -a /srv/usb /dev || {
	echo cannot mount /srv/usb >[1=2]
	exit nousbd
}

disks=()
mtpt=()
switch ($#*) {
case 0
	disks=`{ls -pd /n/sdU*}
case *
	disks=()
	for(a in $*){
		if(~ $a sd??)
			disk=`{ls -pd /n/^$*^*}
		if not
			disk=$a
		disks=($disks $disk)
	}
}
for(disk in $disks){
	unmount /n/^$disk >[2]/dev/null && echo $disk unmounted
	echo del $disk^parts/'*' >/dev/fs/ctl >[2]/dev/null
}
exit ''
